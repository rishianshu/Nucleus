name: Auto-Merge on Codex Approval

on:
  # Trigger when Codex Code Review workflow completes
  workflow_run:
    workflows: ["Codex Code Review"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run if Codex review succeeded
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request'
    
    steps:
      - name: Get PR Number
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            // Get PR number from the workflow run
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (prNumber) {
              console.log(`Found PR #${prNumber}`);
              core.setOutput('pr_number', prNumber);
              return prNumber;
            }
            
            console.log('No PR found in workflow run');
            core.setOutput('pr_number', '');
            return '';

      - name: Enable Auto-Merge
        if: steps.get-pr.outputs.pr_number != ''
        run: |
          echo "Codex review passed for PR #${{ steps.get-pr.outputs.pr_number }}"
          gh pr merge ${{ steps.get-pr.outputs.pr_number }} \
            --auto \
            --squash \
            --delete-branch || echo "Auto-merge may already be enabled or not available"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post Approval Comment
        if: steps.get-pr.outputs.pr_number != ''
        run: |
          gh pr comment ${{ steps.get-pr.outputs.pr_number }} \
            --body "ðŸ¤– **Codex review passed!** Auto-merge enabled. PR will merge when all status checks pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

