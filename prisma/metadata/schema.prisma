generator metadata_client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.metadata-client"
}

datasource db {
  provider = "postgresql"
  url      = env("METADATA_DATABASE_URL")
}

model MetadataProject {
  id          String            @id @default(uuid())
  slug        String            @unique
  displayName String
  description String?
  labels      String[]          @default([])
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  records     MetadataRecord[]
  endpoints   MetadataEndpoint[]
}

model MetadataRecord {
  id        String          @default(uuid())
  projectId String
  project   MetadataProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  domain    String
  labels    String[]        @default([])
  searchText String         @default("")
  payload   Json
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@id([domain, id])
  @@index([projectId, domain])
}

model MetadataEndpoint {
  id          String            @id @default(uuid())
  projectId   String?
  project     MetadataProject?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceId    String            @unique
  name        String
  description String?
  verb        String
  url         String
  authPolicy  String?
  domain      String?
  labels      String[]          @default([])
  config      Json?
  detectedVersion String?
  versionHint String?
  capabilities String[] @default([])
  collections MetadataCollection[]
  runs        MetadataCollectionRun[]
  ingestionConfigs IngestionUnitConfig[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  deletionReason String?

  @@index([projectId])
}

enum MaterializedStatus {
  READY
  INDEXING
  INDEXED
  FAILED
}

model MaterializedArtifact {
  id             String              @id @default(uuid())
  tenantId       String
  sourceRunId    String
  artifactKind   String
  sourceFamily   String?
  sinkEndpointId String?
  handle         Json
  canonicalMeta  Json
  sourceMeta     Json?
  status         MaterializedStatus  @default(READY)
  indexStatus    MaterializedStatus  @default(READY)
  counters       Json?
  indexCounters  Json?
  lastError      Json?
  indexLastError Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@unique([tenantId, sourceRunId, artifactKind])
  @@index([tenantId, artifactKind])
  @@index([tenantId, status])
  @@index([tenantId, indexStatus])
}

model MetadataCollection {
  id                 String               @id @default(uuid())
  endpointId         String
  endpoint           MetadataEndpoint     @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  scheduleCron       String?
  scheduleTimezone   String               @default("UTC")
  isEnabled          Boolean              @default(true)
  temporalScheduleId String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  runs               MetadataCollectionRun[]

  @@index([endpointId])
}

model MetadataDomain {
  id          String   @id @default(uuid())
  key         String   @unique
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MetadataCollectionRun {
  id            String                     @id @default(uuid())
  collectionId  String?
  collection    MetadataCollection?        @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  endpointId    String
  endpoint      MetadataEndpoint           @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  status        MetadataCollectionStatus   @default(QUEUED)
  requestedBy   String?
  requestedAt   DateTime                   @default(now())
  startedAt     DateTime?
  completedAt   DateTime?
  workflowId    String?
  temporalRunId String?
  error         String?
  filters       Json?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt

  @@index([collectionId])
  @@index([endpointId])
}

enum MetadataCollectionStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  SKIPPED
}

model MetadataEndpointTemplate {
  id        String   @id
  family    String
  title     String
  vendor    String
  descriptor Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IngestionUnitState {
  endpointId String
  unitId     String
  sinkId     String
  state      String          @default("IDLE")
  checkpoint Json?
  lastRunId  String?
  lastRunAt  DateTime?
  lastError  String?
  stats      Json?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@id([endpointId, unitId])
  @@index([endpointId])
}

model IngestionUnitConfig {
  id                      String           @id @default(uuid())
  endpointId              String
  endpoint                MetadataEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  datasetId               String
  unitId                  String
  enabled                 Boolean          @default(false)
  runMode                 String           @default("FULL")
  mode                    String           @default("raw")
  sinkId                  String           @default("kb")
  sinkEndpointId          String?
  scheduleKind            String           @default("MANUAL")
  scheduleIntervalMinutes Int?
  policy                  Json?
  filter                  Json?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@unique([endpointId, unitId])
  @@index([datasetId])
}

model GraphNode {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String?
  entityType      String
  displayName     String
  canonicalPath   String?
  sourceSystem    String?
  specRef         String?
  properties      Json     @default("{}")
  version         Int      @default(1)
  scopeOrgId      String
  scopeDomainId   String?
  scopeProjectId  String?
  scopeTeamId     String?
  originEndpointId String?
  originVendor    String?
  logicalKey      String   @unique
  externalId      Json?
  phase           String?
  provenance      Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sourceEdges GraphEdge[] @relation("sourceEdges")
  targetEdges GraphEdge[] @relation("targetEdges")

  @@index([scopeOrgId, entityType])
  @@index([scopeOrgId, scopeProjectId])
}

model GraphEdge {
  id               String   @id @default(uuid())
  tenantId         String
  projectId        String?
  edgeType         String
  sourceNodeId     String
  targetNodeId     String
  sourceNode       GraphNode @relation("sourceEdges", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode       GraphNode @relation("targetEdges", fields: [targetNodeId], references: [id], onDelete: Cascade)
  sourceLogicalKey String
  targetLogicalKey String
  scopeOrgId       String
  scopeDomainId    String?
  scopeProjectId   String?
  scopeTeamId      String?
  originEndpointId String?
  originVendor     String?
  logicalKey       String   @unique
  confidence       Float?
  specRef          String?
  metadata         Json     @default("{}")
  externalId       Json?
  phase            String?
  provenance       Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([scopeOrgId, edgeType])
  @@index([sourceLogicalKey])
  @@index([targetLogicalKey])
}

model KgNodeType {
  id             String   @id
  family         String
  description    String?
  idPrefix       String?
  requiredProps  String[] @default([])
  optionalProps  String[] @default([])
  indexedProps   String[] @default([])
  labelTemplate  String?
  icon           String?

  outgoingEdgeTypes KgEdgeType[] @relation("FromNodeType")
  incomingEdgeTypes KgEdgeType[] @relation("ToNodeType")
}

model KgEdgeType {
  id             String   @id
  fromNodeTypeId String
  fromNodeTypes  String[] @default([])
  toNodeTypeId   String
  direction      String   @default("out")
  description    String?
  multiplicity   String?
  symmetric      Boolean  @default(false)

  fromNodeType KgNodeType @relation("FromNodeType", fields: [fromNodeTypeId], references: [id], onDelete: Cascade)
  toNodeType   KgNodeType @relation("ToNodeType", fields: [toNodeTypeId], references: [id], onDelete: Cascade)

  @@index([fromNodeTypeId])
  @@index([toNodeTypeId])
}

model SignalDefinition {
  id             String           @id @default(uuid())
  slug           String           @unique
  title          String
  description    String?
  status         SignalStatus
  implMode       SignalImplMode   @default(DSL) @map("impl_mode")
  sourceFamily   String?          @map("source_family")
  entityKind     String?          @map("entity_kind")
  processKind    String?        @map("process_kind")
  policyKind     String?        @map("policy_kind")
  severity       SignalSeverity
  tags           String[]         @default([])
  cdmModelId     String?        @map("cdm_model_id")
  surfaceHints   Json?          @map("surface_hints")
  owner          String?
  definitionSpec Json           @map("definition_spec")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  instances      SignalInstance[]

  @@map("signal_definitions")
}

model SignalInstance {
  id           String               @id @default(uuid())
  definitionId String               @map("definition_id")
  definition   SignalDefinition     @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  status       SignalInstanceStatus
  entityRef    String               @map("entity_ref")
  entityKind   String               @map("entity_kind")
  severity     SignalSeverity
  summary      String
  details      Json?
  firstSeenAt  DateTime             @default(now()) @map("first_seen_at")
  lastSeenAt   DateTime             @default(now()) @map("last_seen_at")
  resolvedAt   DateTime?            @map("resolved_at")
  sourceRunId  String?              @map("source_run_id")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")

  @@map("signal_instances")
  @@unique([definitionId, entityRef])
  @@index([definitionId, status])
  @@index([entityRef, definitionId])
  @@index([entityKind, status, severity])
}

model VectorIndexProfile {
  id             String   @id
  family         String
  description    String?
  nodeType       String   @map("node_type")
  textSource     Json     @map("text_source")
  embeddingModel String   @map("embedding_model")
  chunking       Json?    @map("chunking")
  profileKind    String   @map("profile_kind")
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  entries        VectorIndexEntry[]

  @@map("vector_index_profiles")
}

model VectorIndexEntry {
  id           String             @id @default(uuid())
  nodeId       String             @map("node_id")
  profileId    String             @map("profile_id")
  chunkId      String             @map("chunk_id")
  embedding    Unsupported("vector")
  tenantId     String             @map("tenant_id")
  projectKey   String?            @map("project_key")
  profileKind  String             @map("profile_kind")
  sourceSystem String?            @map("source_system")
  rawMetadata  Json?              @map("raw_metadata")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  profile      VectorIndexProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([nodeId, profileId, chunkId])
  @@index([profileId, tenantId])
  @@index([projectKey])
  @@index([profileKind])
  @@map("vector_index_entries")
}

enum SignalStatus {
  ACTIVE
  DISABLED
  DRAFT
}

enum SignalImplMode {
  DSL
  CODE
}

enum SignalInstanceStatus {
  OPEN
  RESOLVED
  SUPPRESSED
}

enum SignalSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}
