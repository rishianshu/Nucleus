# Story — code-vector-profile-and-indexing-v1

- 2025-12-13: Extended pgvector-backed `vector_index_entries` with docId/source metadata and seeded `code.github.v1`, implemented the code index runner/normalizer with deterministic embeddings, MinIO JSONL.GZ reading, and ingestionRunId filtering, and wrote AC1–AC4 tests; brain test suite currently blocked locally by missing METADATA_DATABASE_URL/Postgres.
- 2025-12-14: Pivoted to a single vector store (removed vector_documents), added in-memory profile/vector stores for offline runs, fixed the code index runner API, reran `pnpm --filter @apps/metadata-api test:brain` successfully with deterministic embeddings, applied migration `20251213195500_code_vector_documents` to the local metadata pgvector instance, ran a real GitHub→MinIO ingestion (octocat/Hello-World) with CodeIndexRunner persisting vectors to `metadata.vector_index_entries` (deterministic embeddings), and added a `materialized_artifacts` registry + registry-aware CodeIndexRunner to track index runs (registry not yet fed by ingestion events).
- 2025-12-22: Unblocked IndexArtifact by replaying staged envelopes with `vectorPayload`/`rawPayload`, unwrapping nested payloads for VectorProfile normalizers, defaulting KV checkpoints to store-core on 9099, and adding Go tests for staging replay + normalization (GOCACHE=/tmp/go-cache go test ./internal/activities).
